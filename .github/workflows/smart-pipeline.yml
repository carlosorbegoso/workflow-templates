name: Smart CI/CD Pipeline

on:
  workflow_call:
    secrets:
      # Production secrets
      SSH_HOST:
        required: false
      SSH_USER:
        required: false
      SSH_PRIVATE_KEY:
        required: false
      DEPLOY_PATH:
        required: false
      
      # Development secrets
      DEV_SSH_HOST:
        required: false
      DEV_SSH_USER:
        required: false
      DEV_SSH_PRIVATE_KEY:
        required: false
      DEV_DEPLOY_PATH:
        required: false
      
      # Registry secrets
      GHCR_USERNAME:
        required: false
      GHCR_PAT:
        required: false
      
      # Database secrets
      DB_USERNAME:
        required: false
      DB_PASSWORD:
        required: false
      DEV_DB_USERNAME:
        required: false
      DEV_DB_PASSWORD:
        required: false
      
      # Quality secrets
      SONAR_TOKEN:
        required: false

jobs:
  # Job para detectar el entorno y configuración
  setup:
    name: Setup Pipeline
    runs-on: ubuntu-latest
    outputs:
      is_production: ${{ steps.detect.outputs.is_production }}
      is_development: ${{ steps.detect.outputs.is_development }}
      is_pr: ${{ steps.detect.outputs.is_pr }}
      run_tests: ${{ steps.detect.outputs.run_tests }}
      run_quality: ${{ steps.detect.outputs.run_quality }}
      run_security: ${{ steps.detect.outputs.run_security }}
      run_build: ${{ steps.detect.outputs.run_build }}
      run_deploy: ${{ steps.detect.outputs.run_deploy }}
      ssh_host: ${{ steps.detect.outputs.ssh_host }}
      ssh_user: ${{ steps.detect.outputs.ssh_user }}
      ssh_key: ${{ steps.detect.outputs.ssh_key }}
      deploy_path: ${{ steps.detect.outputs.deploy_path }}
      db_username: ${{ steps.detect.outputs.db_username }}
      db_password: ${{ steps.detect.outputs.db_password }}
    
    steps:
      - name: Detect environment and configure pipeline
        id: detect
        run: |
          echo "Event: ${{ github.event_name }}"
          echo "Ref: ${{ github.ref }}"
          echo "Branch: ${{ github.ref_name }}"
          
          # Detectar tipo de pipeline
          if [ "${{ github.event_name }}" = "pull_request" ]; then
            # PULL REQUEST: Solo tests rápidos
            echo "is_pr=true" >> $GITHUB_OUTPUT
            echo "is_production=false" >> $GITHUB_OUTPUT
            echo "is_development=false" >> $GITHUB_OUTPUT
            echo "run_tests=true" >> $GITHUB_OUTPUT
            echo "run_quality=false" >> $GITHUB_OUTPUT
            echo "run_security=false" >> $GITHUB_OUTPUT
            echo "run_build=false" >> $GITHUB_OUTPUT
            echo "run_deploy=false" >> $GITHUB_OUTPUT
            echo "Pipeline: PR - Tests rápidos solamente"
            
          elif [ "${{ github.ref_name }}" = "main" ]; then
            # PRODUCCIÓN: Build y deploy rápido
            echo "is_production=true" >> $GITHUB_OUTPUT
            echo "is_development=false" >> $GITHUB_OUTPUT
            echo "is_pr=false" >> $GITHUB_OUTPUT
            echo "run_tests=false" >> $GITHUB_OUTPUT
            echo "run_quality=false" >> $GITHUB_OUTPUT
            echo "run_security=false" >> $GITHUB_OUTPUT
            echo "run_build=true" >> $GITHUB_OUTPUT
            echo "run_deploy=true" >> $GITHUB_OUTPUT
            
            # Secrets de producción
            echo "ssh_host=${{ secrets.SSH_HOST }}" >> $GITHUB_OUTPUT
            echo "ssh_user=${{ secrets.SSH_USER }}" >> $GITHUB_OUTPUT
            echo "ssh_key=${{ secrets.SSH_PRIVATE_KEY }}" >> $GITHUB_OUTPUT
            echo "deploy_path=${{ secrets.DEPLOY_PATH }}" >> $GITHUB_OUTPUT
            echo "db_username=${{ secrets.DB_USERNAME }}" >> $GITHUB_OUTPUT
            echo "db_password=${{ secrets.DB_PASSWORD }}" >> $GITHUB_OUTPUT
            echo "Pipeline: PRODUCCIÓN - Build y deploy rápido"
            
          else
            # DESARROLLO: Pipeline completo
            echo "is_development=true" >> $GITHUB_OUTPUT
            echo "is_production=false" >> $GITHUB_OUTPUT
            echo "is_pr=false" >> $GITHUB_OUTPUT
            echo "run_tests=true" >> $GITHUB_OUTPUT
            echo "run_quality=true" >> $GITHUB_OUTPUT
            echo "run_security=true" >> $GITHUB_OUTPUT
            echo "run_build=true" >> $GITHUB_OUTPUT
            echo "run_deploy=true" >> $GITHUB_OUTPUT
            
            # Secrets de desarrollo (con fallback a producción)
            DEV_HOST="${{ secrets.DEV_SSH_HOST }}"
            PROD_HOST="${{ secrets.SSH_HOST }}"
            echo "ssh_host=${DEV_HOST:-$PROD_HOST}" >> $GITHUB_OUTPUT
            
            DEV_USER="${{ secrets.DEV_SSH_USER }}"
            PROD_USER="${{ secrets.SSH_USER }}"
            echo "ssh_user=${DEV_USER:-$PROD_USER}" >> $GITHUB_OUTPUT
            
            DEV_KEY="${{ secrets.DEV_SSH_PRIVATE_KEY }}"
            PROD_KEY="${{ secrets.SSH_PRIVATE_KEY }}"
            echo "ssh_key=${DEV_KEY:-$PROD_KEY}" >> $GITHUB_OUTPUT
            
            DEV_PATH="${{ secrets.DEV_DEPLOY_PATH }}"
            PROD_PATH="${{ secrets.DEPLOY_PATH }}"
            echo "deploy_path=${DEV_PATH:-$PROD_PATH}" >> $GITHUB_OUTPUT
            
            DEV_DB_USER="${{ secrets.DEV_DB_USERNAME }}"
            PROD_DB_USER="${{ secrets.DB_USERNAME }}"
            echo "db_username=${DEV_DB_USER:-$PROD_DB_USER}" >> $GITHUB_OUTPUT
            
            DEV_DB_PASS="${{ secrets.DEV_DB_PASSWORD }}"
            PROD_DB_PASS="${{ secrets.DB_PASSWORD }}"
            echo "db_password=${DEV_DB_PASS:-$PROD_DB_PASS}" >> $GITHUB_OUTPUT
            echo "Pipeline: DESARROLLO - Pipeline completo con calidad"
          fi

  # Tests (solo para PR y desarrollo)
  test:
    name: Run Tests
    needs: setup
    if: needs.setup.outputs.run_tests == 'true'
    uses: carlosorbegoso/workflow-templates/.github/workflows/test.yml@main
    with:
      java_version: '21'
      run_integration_tests: ${{ needs.setup.outputs.is_development == 'true' }}

  # Quality checks (solo para desarrollo)
  quality:
    name: Quality Checks
    needs: [setup, test]
    if: needs.setup.outputs.run_quality == 'true' && (needs.test.result == 'success' || needs.test.result == 'skipped')
    uses: carlosorbegoso/workflow-templates/.github/workflows/quality-check.yml@main
    with:
      sonar_enabled: true
    secrets:
      SONAR_TOKEN: ${{ secrets.SONAR_TOKEN }}

  # Security scan (solo para desarrollo)
  security:
    name: Security Scan
    needs: setup
    if: needs.setup.outputs.run_security == 'true'
    uses: carlosorbegoso/workflow-templates/.github/workflows/security-scan.yml@main
    with:
      scan_dependencies: true
      scan_code: true

  # Build (para producción y desarrollo)
  build:
    name: Build Native Image
    needs: [setup, test, quality, security]
    if: needs.setup.outputs.run_build == 'true' && always() && (needs.test.result == 'success' || needs.test.result == 'skipped') && (needs.quality.result == 'success' || needs.quality.result == 'skipped') && (needs.security.result == 'success' || needs.security.result == 'skipped')
    uses: carlosorbegoso/workflow-templates/.github/workflows/build.yml@main

  # Push to registry
  push:
    name: Push to Registry
    needs: [setup, build]
    if: needs.setup.outputs.run_build == 'true' && needs.build.result == 'success'
    uses: carlosorbegoso/workflow-templates/.github/workflows/push.yml@main
    with:
      use_ghcr: true
      push_to_registry: true
    secrets:
      GHCR_USERNAME: ${{ secrets.GHCR_USERNAME }}
      GHCR_PAT: ${{ secrets.GHCR_PAT }}

  # Deploy (para producción y desarrollo)
  deploy:
    name: Deploy Application
    needs: [setup, push]
    if: needs.setup.outputs.run_deploy == 'true' && needs.push.result == 'success'
    uses: carlosorbegoso/workflow-templates/.github/workflows/deploy.yml@main
    with:
      image_version: ${{ needs.push.outputs.image-version }}
      push_to_registry: true
    secrets:
      SSH_HOST: ${{ needs.setup.outputs.ssh_host }}
      SSH_USER: ${{ needs.setup.outputs.ssh_user }}
      SSH_PRIVATE_KEY: ${{ needs.setup.outputs.ssh_key }}
      DEPLOY_PATH: ${{ needs.setup.outputs.deploy_path }}
      GHCR_USERNAME: ${{ secrets.GHCR_USERNAME }}
      GHCR_PAT: ${{ secrets.GHCR_PAT }}
      DB_USERNAME: ${{ needs.setup.outputs.db_username }}
      DB_PASSWORD: ${{ needs.setup.outputs.db_password }}

  # Summary job
  summary:
    name: Pipeline Summary
    needs: [setup, test, quality, security, build, push, deploy]
    if: always()
    runs-on: ubuntu-latest
    steps:
      - name: Pipeline Summary
        run: |
          echo "================================"
          echo "PIPELINE SUMMARY"
          echo "================================"
          echo "Environment: ${{ needs.setup.outputs.is_production == 'true' && 'PRODUCTION' || needs.setup.outputs.is_development == 'true' && 'DEVELOPMENT' || 'PULL REQUEST' }}"
          echo "Branch: ${{ github.ref_name }}"
          echo "Event: ${{ github.event_name }}"
          echo ""
          echo "Jobs executed:"
          echo "- Tests: ${{ needs.setup.outputs.run_tests }}"
          echo "- Quality: ${{ needs.setup.outputs.run_quality }}"
          echo "- Security: ${{ needs.setup.outputs.run_security }}"
          echo "- Build: ${{ needs.setup.outputs.run_build }}"
          echo "- Deploy: ${{ needs.setup.outputs.run_deploy }}"
          echo ""
          echo "Results:"
          echo "- Tests: ${{ needs.test.result || 'skipped' }}"
          echo "- Quality: ${{ needs.quality.result || 'skipped' }}"
          echo "- Security: ${{ needs.security.result || 'skipped' }}"
          echo "- Build: ${{ needs.build.result || 'skipped' }}"
          echo "- Push: ${{ needs.push.result || 'skipped' }}"
          echo "- Deploy: ${{ needs.deploy.result || 'skipped' }}"