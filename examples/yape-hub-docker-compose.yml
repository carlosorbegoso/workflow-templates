# ============================================
# DOCKER-COMPOSE PARA YAPE-HUB
# ============================================
# 
# Copia este archivo como docker-compose.yml
# en la raíz de tu proyecto yape-hub
#
# ============================================

version: '3.8'

services:
  # Base de datos PostgreSQL
  postgres:
    image: postgres:15
    container_name: yape-hub-postgres
    environment:
      - POSTGRES_DB=yape_hub
      - POSTGRES_USER=${DB_USERNAME}
      - POSTGRES_PASSWORD=${DB_PASSWORD}
    volumes:
      - postgres_data:/var/lib/postgresql/data
    ports:
      - "5432:5432"
    networks:
      - yape-network
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U ${DB_USERNAME} -d yape_hub"]
      interval: 10s
      timeout: 5s
      retries: 5

  # Aplicación Quarkus
  app:
    image: ${DOCKER_IMAGE}
    container_name: ${APP_NAME}
    depends_on:
      postgres:
        condition: service_healthy
    ports:
      - "8080:8080"
    environment:
      - QUARKUS_HTTP_HOST=0.0.0.0
      - QUARKUS_HTTP_PORT=8080
      - QUARKUS_PROFILE=prod
      
      # Variables de base de datos (apuntando al contenedor postgres)
      - QUARKUS_DATASOURCE_USERNAME=${DB_USERNAME}
      - QUARKUS_DATASOURCE_PASSWORD=${DB_PASSWORD}
      - QUARKUS_DATASOURCE_JDBC_URL=jdbc:postgresql://postgres:5432/yape_hub
      - QUARKUS_DATASOURCE_DB_KIND=postgresql
      
      # Configuración JPA
      - QUARKUS_JPA_HIBERNATE_DATABASE_GENERATION=update
      - QUARKUS_JPA_HIBERNATE_LOG_SQL=false
      
      # Logging
      - QUARKUS_LOG_LEVEL=INFO
      
    restart: unless-stopped
    
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8080/q/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 60s
    
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"
    
    networks:
      - yape-network

volumes:
  postgres_data:

networks:
  yape-network:
    driver: bridge

# ============================================
# VARIABLES REQUERIDAS:
# ============================================
#
# ${DOCKER_IMAGE} - Se pasa automáticamente desde el workflow
# ${APP_NAME} - Se pasa automáticamente (yape-hub)
# ${DB_USERNAME} - Desde secrets.DB_USERNAME
# ${DB_PASSWORD} - Desde secrets.DB_PASSWORD
# ${DB_JDBC_URL} - Opcional, usa default si no se proporciona
#
# ============================================